<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="面试问题：在一个表里面有可能有数据，有可能没有数据，请查询工资第二高的数据： select IFNULL((select Distinct Salary from Employee order by Salary DESC limit 1,1),null) as SecondHighestSalary 在用limit时，如果没有结果，或报错，所以需要用ifnull判断一下 下载安装 下载tar版本">
<meta property="og:type" content="article">
<meta property="og:title" content="mysql笔记">
<meta property="og:url" content="http://1525.xyz/2020/08/20/mysql%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Tom&#39;s Blog">
<meta property="og:description" content="面试问题：在一个表里面有可能有数据，有可能没有数据，请查询工资第二高的数据： select IFNULL((select Distinct Salary from Employee order by Salary DESC limit 1,1),null) as SecondHighestSalary 在用limit时，如果没有结果，或报错，所以需要用ifnull判断一下 下载安装 下载tar版本">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-08-20T15:06:24.000Z">
<meta property="article:modified_time" content="2020-08-22T01:14:00.342Z">
<meta property="article:author" content="tom">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://1525.xyz/2020/08/20/mysql笔记/"/>





  <title>mysql笔记 | Tom's Blog</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Tom's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://1525.xyz/2020/08/20/mysql%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tom">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tom's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">mysql笔记</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-08-20T23:06:24+08:00">
                2020-08-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="面试问题："><a href="#面试问题：" class="headerlink" title="面试问题："></a>面试问题：</h3><p>在一个表里面有可能有数据，有可能没有数据，请查询工资第二高的数据：</p>
<p>select IFNULL((select Distinct Salary from Employee order by Salary DESC limit 1,1),null) as SecondHighestSalary</p>
<p>在用limit时，如果没有结果，或报错，所以需要用ifnull判断一下</p>
<h3 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h3><ol>
<li>下载tar版本的，解压后放入到/usr/local/mysql中</li>
<li>执行/usr/local/mysql/bin/mysqld –initialize –user=mysql初始化mysql，生成临时密码</li>
<li>登录mysql,mysql -u root -p 输入上面的密码</li>
<li>修改密码set password=password(‘mima’); </li>
<li>添加远程访问的权限grant all privileges on <em>.</em> to ‘root’ @’%’ identified by ‘mima’;flush privileges;</li>
</ol>
<h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><p>定义：索引是帮助MySQL高效获取数据的一种数据结构</p>
<p>常见的模型：</p>
<ol>
<li>hash表：哈希表这种结构适用于只有等值查询的场景，比如Memcached及其他一些NoSQL引擎。</li>
<li>有序数组：有序数组在等值查询和范围查询场景中的性能就都非常优秀，有序数组索引只适用于静态存储引擎</li>
<li>搜索树</li>
</ol>
<p>在mysql中，索引是由存储引擎实现的</p>
<p>优势：提高数据的查询效率，降低io成本，通过索引对数据进行排序，降低数据排序的成本，降低cpu的消耗。</p>
<p>劣势：索引实际也是一个表，保存了主键与索引字段，所以是索引也是要占用空间的，对表的修改删除插入，带来额外的副作用。</p>
<h3 id="索引的结构："><a href="#索引的结构：" class="headerlink" title="索引的结构："></a>索引的结构：</h3><p>mysql目前提供了4种结构：</p>
<ul>
<li>BTREE 索引 ： 最常见的索引类型，大部分引擎都支持 B 树索引。</li>
<li>HASH 索引：只有Memory引擎支持 ， 使用场景简单 。</li>
<li>R-tree 索引（空间索引）：空间索引是MyISAM引擎的一个特殊索引类型，主要用于地理空间数据类型，通常使用较少，不做特别介绍。</li>
<li>Full-text （全文索引） ：全文索引也是MyISAM的一个特殊索引类型，主要用于全文索引，InnoDB从Mysql5.6版本开始支持全文索引</li>
</ul>
<table>
<thead>
<tr>
<th>索引</th>
<th>InnoDB引擎</th>
<th>MyISAM引擎</th>
<th>Memory引擎</th>
</tr>
</thead>
<tbody><tr>
<td>BTREE索引</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>HASH 索引</td>
<td>不支持</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>R-tree 索引</td>
<td>不支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>Full-text</td>
<td>5.6版本之后支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
</tbody></table>
<p>在B+树索引中，主键长度越小，普通索引的叶子节点就越小，普通索引占用的空间也就越小。所以，从性能和存储空间方面考量，自增主键往往是更合理的选择</p>
<p>有没有什么场景适合用业务字段直接做主键的呢?还是有的。比如，有些业务的场景需求是这样的:</p>
<ol>
<li>只有一个索引。</li>
<li>该索引必须是唯一索引。</li>
</ol>
<p>你一定看出来了，这就是典型的KV场景。</p>
<p>由于没有其他索引，所以也就不用考虑其他索引的叶子节点大小的问题。</p>
<h4 id="索引类型"><a href="#索引类型" class="headerlink" title="索引类型"></a>索引类型</h4><ol>
<li>聚集索引（主键索引）：不用回表</li>
<li>非聚集索引（二级索引）：如果查询的数据不在索引范围内，需回表</li>
</ol>
<h5 id="索引覆盖"><a href="#索引覆盖" class="headerlink" title="索引覆盖"></a>索引覆盖</h5><p>定义：指的是查询的数据在非聚集索引里面是存有数据的，则不需要通过回表去查询数据。</p>
<p>由于覆盖索引可以减少树的搜索次数，显著提升查询性能，所以使用覆盖索引是一个常用 的性能优化手段。</p>
<h5 id="最左前缀原则"><a href="#最左前缀原则" class="headerlink" title="最左前缀原则"></a>最左前缀原则</h5><p>这个最左前缀可以是联合索引的最左N个字段，也可以是字符串索引的最左M个字符。</p>
<h5 id="在建立联合索引的时候，如何安排索-引内的字段顺序。"><a href="#在建立联合索引的时候，如何安排索-引内的字段顺序。" class="headerlink" title="在建立联合索引的时候，如何安排索 引内的字段顺序。"></a>在建立联合索引的时候，如何安排索 引内的字段顺序。</h5><ol>
<li>第一原则是，如果通过调整顺序，可 以少维护一个索引，那么这个顺序往往就是需要优先考虑采用的。</li>
<li>考虑的原则就是空间:如一个表里面有两个字段a,b，既要按a,b两个条件来查询，又要分别能通过a,b条件进行查询，这个时候想到较优的方案是建立一个(a,b)或者(b,a)的联合索引，通过在单独为a或者b建立一个索引，这个时候就可以从空间的角度来考虑，如果a比b占用的空间大，那a就让他出现一次就行了，就建立(a,b)联合索引加上一个b的索引即可。</li>
</ol>
<h5 id="索引下推"><a href="#索引下推" class="headerlink" title="索引下推"></a>索引下推</h5><h3 id="命令："><a href="#命令：" class="headerlink" title="命令："></a>命令：</h3><ol>
<li>show processlist查看连接情况</li>
</ol>
<h3 id="基础架构："><a href="#基础架构：" class="headerlink" title="基础架构："></a>基础架构：</h3><p>mysql大体分为架构可以分为两成：</p>
<ol>
<li><p>server层</p>
<p>server层包括了：</p>
<ol>
<li>连接器：负责和客户端建立链接，获取权限，维持和管理连接</li>
<li>查询缓存：用于缓存查询，key是sql语句，value是结果集，8.0后删除这个组件</li>
<li>分析器：对sql语句进行分析</li>
<li>优化器：决定使用哪个索引，决定多表连接时表连接的顺序</li>
<li>执行器：权限检查，调用引擎接口执行查询</li>
</ol>
</li>
<li><p>存储引擎层（插件式）存储数据，提供读写接口，支持的存储引擎有：</p>
<ol>
<li>InnoDB(5.5.5后默认)</li>
<li>MySAM</li>
<li>Memory</li>
</ol>
</li>
</ol>
<p>mysql中的日志：</p>
<ol>
<li>重做日志（redo log）<ol>
<li>作用：确保事务的持久性（crash-safe）,让制在发生故障的时间段，还有为写入磁盘的数据，在mysql重启后，会通过redo log进行重做</li>
<li>内容：物理格式日志，记录的是物理数据也没修改的信息，其redo log是顺序写入redo log file的物理文件中去的。</li>
<li>什么时候产生：事务开始之后就产生redo log，redo log的落盘并不是随着事务的提交才写入的，而是在事务的执行过程中，便开始写入redo log文件中。</li>
<li>什么时候释放：当对应事务的脏页写入到磁盘之后，redo log的使命也就完成了，重做日志占用的空间就可以重用（被覆盖）。</li>
<li>刷盘：redo log有一个buffer,会先写到buffer中，在通过以下情况刷新到磁盘上<ol>
<li>Master Thread 每秒一次执行刷新Innodb_log_buffer到重做日志文件。</li>
<li>每个事务提交时会将重做日志刷新到重做日志文件。</li>
<li>当重做日志缓存可用空间 少于一半时，重做日志缓存被刷新到重做日志文件</li>
</ol>
</li>
</ol>
</li>
<li>回滚日志（undo log）<ol>
<li>作用：保存事务发生前数据的一个版本，可以用于回滚，也可以提供MVCC（非锁定读）</li>
<li>内容：逻辑格式的日志，在执行undo的时候，仅仅是将数据从逻辑上恢复至事务之前的状态，而不是从物理页面上操作实现的，这一点是不同于redo log的。</li>
<li>什么时候产生：事务开始之前，将当前是的版本生成undo log，undo 也会产生 redo 来保证undo log的可靠性</li>
<li>什么时候释放：当事务提交之后，undo log并不能立马被删除而是放入待清理的链表，由purge线程判断是否由其他事务在使用undo段中表的上一个事务之前的版本信息，决定是否可以清理undo log的日志空间。</li>
</ol>
</li>
<li>二进制日志（binlog）<ol>
<li>作用：（1）用于复制，在主从复制中，从库利用主库上的binlog进行重播，（2）实现主从同步用于数据库的基于时间点的还原</li>
<li>作用：逻辑格式的日志，可以简单认为就是执行过的事务中的sql语句。但又不完全是sql语句这么简单，而是包括了执行的sql语句（增删改）反向的信息，也就意味着delete对应着delete本身和其反向的insert；update对应着update执行前后的版本的信息；insert对应着delete和insert本身的信息。在使用mysqlbinlog解析binlog之后一些都会真相大白。因此可以基于binlog做到类似于oracle的闪回功能，其实都是依赖于binlog中的日志记录。</li>
<li>什么时候产生：事务提交的时候，一次性将事务中的sql语句（一个事物可能对应多个sql语句）按照一定的格式记录到binlog中（这里与redo log很明显的差异就是redo log并不一定是在事务提交的时候刷新到磁盘，redo log是在事务开始之后就开始逐步写入磁盘。）因此对于事务的提交，即便是较大的事务，提交（commit）都是很快的，但是在开启了bin_log的情况下，对于较大事务的提交，可能会变得比较慢一些。</li>
<li>什么时候释放：binlog的默认是保持时间由参数expire_logs_days配置，也就是说对于非活动的日志文件，在生成时间超过expire_logs_days配置的天数之后，会被自动删除。</li>
<li>其他：二进制日志的作用之一是还原数据库的，这与redo log很类似，很多人混淆过，但是两者有本质的不同<ol>
<li>作用不同：redo log是保证事务的持久性的，是事务层面的，binlog作为还原的功能，是数据库层面的（当然也可以精确到事务层面的），虽然都有还原的意思，但是其保护数据的层次是不一样的</li>
<li>内容不同：redo log是物理日志，是数据页面的修改之后的物理记录，binlog是逻辑日志，可以简单认为记录的就是sql语句</li>
<li>另外，两者日志产生的时间，可以释放的时间，在可释放的情况下清理机制，都是完全不同的。</li>
<li>恢复数据时候的效率，基于物理日志的redo log恢复数据的效率要高于语句逻辑日志的binlog</li>
<li>关于事务提交时，redo log和binlog的写入顺序，为了保证主从复制时候的主从一致（当然也包括使用binlog进行基于时间点还原的情况），是要严格一致的，MySQL通过两阶段提交过程来完成事务的一致性的，也即redo log和binlog的一致性的，理论上是先写redo log，再写binlog，两个日志都提交成功（刷入磁盘），事务才算真正的完成。</li>
</ol>
</li>
</ol>
</li>
<li>错误日志（errorlog）</li>
<li>慢查询日志（slow query log）</li>
<li>一般查询日志（general log）</li>
<li>中继日志（relay log）</li>
</ol>
<h3 id="日志模块："><a href="#日志模块：" class="headerlink" title="日志模块："></a>日志模块：</h3><h4 id="redo-log-（InnoDB引擎特有的日志）"><a href="#redo-log-（InnoDB引擎特有的日志）" class="headerlink" title="redo log （InnoDB引擎特有的日志）"></a>redo log （InnoDB引擎特有的日志）</h4><h5 id="WAL技术-Write-Ahead-Logging"><a href="#WAL技术-Write-Ahead-Logging" class="headerlink" title="WAL技术:(Write- Ahead Logging)"></a>WAL技术:(Write- Ahead Logging)</h5><p>先写日志，在写磁盘，详细来说就是有一个更新的操作时，InnoDB引擎会将记录写到redo log里面去，并更新内存，这个时候，更新就算完成了，同时，InnoDB会在适当的时候，将这个操作更新到磁盘里面，这个更新往往是在系统比较空闲的时候做的。</p>
<p> InnoDB的redo log是 固定大小的，可以成一组几个文件，每个文件大小是1gb，成环状，写到末尾写完了就从头开始写。</p>
<p>redo log里面有两个指针，一个是write pos,一个是checkPoint,write pos记录的是当前写入的位置，一边写入一边往后移动，checkpoint是当前要擦除的位置，在擦除之前需要将记录更新到数据文件中，write pos和checkpoint直接的部分就是空余的可以写入记录的部分，如果write pos 追上checkpoint，表示“粉板”满了，这时候不能再执行新的更新，得停下来先擦掉一些记录，把 checkpoint推进一下。</p>
<p>有了redo log，InnoDB可以保证数据库即使发生异常重启，也不会丢失之前的记录（crash-safe）</p>
<h4 id="binlog（Server层的日志）归档日志"><a href="#binlog（Server层的日志）归档日志" class="headerlink" title="binlog（Server层的日志）归档日志"></a>binlog（Server层的日志）归档日志</h4><h4 id="两者差异："><a href="#两者差异：" class="headerlink" title="两者差异："></a>两者差异：</h4><ol>
<li>redo log是InnoDB特有的，binlog是mysql server层的，所有的存储引擎都可以使用。</li>
<li>redo log记录的是物理日志，记录了在数据页上修改了什么，而binlog是逻辑日志，记录的是原始逻辑。</li>
<li>redo log是循环写，而binlog是可以追加的，写到一定大小就会切换到写一个文件继续写，不会覆盖原有的日志。</li>
</ol>
<h4 id="修改数据的执行流程"><a href="#修改数据的执行流程" class="headerlink" title="修改数据的执行流程"></a>修改数据的执行流程</h4><p>如执行： update T set c=c+1 where ID=2;</p>
<p>流程为：</p>
<ol>
<li>执行器先找引擎取ID=2这一行。ID是主键，引擎直接用树搜索找到这一行。如果ID=2这一 行所在的数据页本来就在内存中，就直接返回给执行器;否则，需要先从磁盘读入内存，然 后再返回。</li>
<li>执行器拿到引擎给的行数据，把这个值加上1，比如原来是N，现在就是N+1，得到新的一行 数据，再调用引擎接口写入这行新数据。</li>
<li>引擎将这行新数据更新到内存中，同时将这个更新操作记录到redolog里面，此时redolog处 于prepare状态。然后告知执行器执行完成了，随时可以提交事务。</li>
<li>执行器生成这个操作的binlog，并把binlog写入磁盘。</li>
<li>执行器调用引擎的提交事务接口，引擎把刚刚写入的redolog改成提交(commit)状态，更新完成。</li>
</ol>
<h4 id="事务隔离："><a href="#事务隔离：" class="headerlink" title="事务隔离："></a>事务隔离：</h4><p>事务简单来说就是要保证一组数据库操作，要么全部成功，要么全部失败。</p>
<p>mysql的事务是由存储引擎实现的，MyISAM不支持事务，这也是InnoDB取代他的重要原因。</p>
<p>Acid: 原子性，一致性，隔离性，持久性</p>
<p>当数据库上有多个事务同时执行的时候，就可能出现：</p>
<ol>
<li>脏读(dirty read)</li>
<li>不可重复读(non-repeatable read)</li>
<li>幻读(phantom read)</li>
</ol>
<p>为了解决这些问题，就有了“隔离级别”的概念。在谈隔离级别之前，你首先要知道，你隔离得越严实，效率就会越低。因此很多时候，我们都要 在二者之间寻找一个平衡点</p>
<p>SQL标准的事务隔离级别包括:</p>
<ol>
<li>读未提交(read uncommitted)：一个事务还没提交时，他做的变更能被其他事务看到，没有视图，直接返回数据</li>
<li>读提交(read committed)：一个事务提交后，他做的变更才能被其他事务看到，每个sql开始执行的时候创建视图</li>
<li>可重复读(repeatable read)：一个事务执行的过程中看到的数据总是和他启动事务时看到的数据一致（可以重复查询，查到的结果都一样），在当前事务隔离级别下所做的变更也需要提交后才可以看到。事务开始的时候创建视图</li>
<li>串行化(serializable )：“写”会加“写锁”，“读”会加“读锁”。当出现读写锁冲突 的时候，后访问的事务必须等前一个事务执行完成，才能继续执行，通过加锁的方式来避免并发访问</li>
</ol>
<p>不同隔离机制下查询结果的差异：</p>
<table>
<thead>
<tr>
<th align="center">事务A</th>
<th>事务B</th>
</tr>
</thead>
<tbody><tr>
<td align="center">启动事务，查询结果为1</td>
<td>启动事务</td>
</tr>
<tr>
<td align="center"></td>
<td>查询得到结果为1</td>
</tr>
<tr>
<td align="center"></td>
<td>将结果由1改为2</td>
</tr>
<tr>
<td align="center">查询得到值V1</td>
<td></td>
</tr>
<tr>
<td align="center"></td>
<td>提交事务B</td>
</tr>
<tr>
<td align="center">查询得到值V2</td>
<td></td>
</tr>
<tr>
<td align="center">提交事务A</td>
<td></td>
</tr>
<tr>
<td align="center">查询得到值V3</td>
<td></td>
</tr>
</tbody></table>
<p>结果如下：</p>
<table>
<thead>
<tr>
<th align="center">隔离级别</th>
<th>V1</th>
<th>V2</th>
<th align="center">V3</th>
</tr>
</thead>
<tbody><tr>
<td align="center">读未提交</td>
<td>2</td>
<td>2</td>
<td align="center">2</td>
</tr>
<tr>
<td align="center">读提交</td>
<td>1</td>
<td>2</td>
<td align="center">2</td>
</tr>
<tr>
<td align="center">可重复读</td>
<td>1</td>
<td>1</td>
<td align="center">2</td>
</tr>
<tr>
<td align="center">串行</td>
<td>1</td>
<td>1</td>
<td align="center">2</td>
</tr>
</tbody></table>
<p>若隔离级别是“串行化”，则在事务B执行“将1改成2”的时候，会被锁住。直到事务A提交后， 事务B才可以继续执行。所以从A的角度看， V1、V2值是1，V3的值是2。</p>
<p>事务隔离的实现：</p>
<p>在MySQL中，实际上每条记录在更新的时候都会同时记录一条回滚操作（undo log）。记录上的最新值，通 过回滚操作，都可以得到前一个状态的值。同一条记录在系统中可以存在多 个版本，就是数据库的多版本并发控制(MVCC—-multiple-version-concurrency-control),回滚日志不会一直保留，在不需要的时候才删除。 也就是说，系统会判断，当没有事务再需要用到这些回滚日志时，回滚日志会被删除。就是当系统里没有比这个回滚日志更早的read-view的时候。</p>
<h4 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h4><p>mysql中的锁可以分为三种：</p>
<ol>
<li><h5 id="全局锁"><a href="#全局锁" class="headerlink" title="全局锁"></a>全局锁</h5><ol>
<li>全局读锁<ol>
<li>开启方式：flush tables with read lock(ftwrl)</li>
<li>影响：其他线程对数据库的增删改，建表，修改表结构或阻塞</li>
<li>使用场景：全库逻辑备份（在从库上，主库就直接业务停摆了）</li>
<li>逻辑备份InnoDB上还有一个支持：mysqldump ––single-transaction，这个会启动一个事务，这样就会拿到一个一致性视图，由于mvcc的支持，这个过程中数据是可以正常更新的。</li>
<li>不推荐使用set global readonly=true来实现全库只读，因为这个配置有可能用来判断一个库是主库还是从库，还有一点ftwrl在遇到异常的时候会主动释放锁，而readonly=true不会。</li>
</ol>
</li>
</ol>
</li>
<li><h5 id="表级锁"><a href="#表级锁" class="headerlink" title="表级锁"></a>表级锁</h5><ol>
<li><p>表级锁分为两种：（1）表锁，（2）元数据锁</p>
</li>
<li><p>表锁开启方式：lock tables xxx read/wite (lock tables user read,order write)user其他线程对user表的写入会阻塞，对order表的读写都会阻塞</p>
</li>
<li><p>元数据锁：不需要显示使用，在对表锁增删改查是会加一个mdl读锁，保证表结构不被修改，在修改表结构时，加一个mdl写锁，保证在修改完成后才能进行数据的读写以及表结构的修改</p>
</li>
<li><p>元数据锁的坑：MDL会等到事务提交时才释放锁，如下</p>
</li>
</ol>
</li>
</ol>
<table>
<thead>
<tr>
<th align="center">sessionA</th>
<th align="center">sessionB</th>
<th align="center">sessionC</th>
<th align="center">sessionD</th>
</tr>
</thead>
<tbody><tr>
<td align="center">begin</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">Select * from t(对t加一个mdl的读锁)</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">select *from t(对t加一个mdl的读锁不互斥，正常秩序)</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Alter table t add f int(对t加一个写锁，由于sessionA还没有释放锁，所以这里会阻塞)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">Select * from t (对t加一个mdl的读锁,由于sessionC中的加写锁，并且阻塞了，导致后续的读锁也会被阻塞)</td>
</tr>
</tbody></table>
<ol start="5">
<li>修改表结构的安全做法：在alter table语句里面<strong>设定等待时间</strong>，如果在这个指定的等待时间里面能够拿到MDL写锁最好，拿不到也不要阻塞后 面的业务语句，先放弃。之后开发人员或者DBA再通过重试命令重复这个过程。</li>
</ol>
<ol start="3">
<li><h5 id="行锁"><a href="#行锁" class="headerlink" title="行锁"></a>行锁</h5><ol>
<li><p>行锁是有存储引擎实现的</p>
</li>
<li><p>在InnoDB事务中，行锁是在需要的时候才加上的，但并不是不需要了就立刻释放，而是要等到事务结束时才释放。这个就是两阶段锁协议。</p>
</li>
<li><p>如果你的事务中需要锁多个行，要把 最可能造成锁冲突、最可能影响并发度的锁尽量往后放。</p>
</li>
<li><p>死锁和死锁检测</p>
<ol>
<li><p>例子</p>
<table>
<thead>
<tr>
<th>事务A</th>
<th>事务B</th>
</tr>
</thead>
<tbody><tr>
<td>Begin;<br />update t set k=k+1 where id=1;–增对Id为1的这行加了一个行锁</td>
<td>Begin;</td>
</tr>
<tr>
<td></td>
<td>Update t set k=k+1 where id=2;–增对Id为2的这行加了一个行锁</td>
</tr>
<tr>
<td>Update t set k=k+1 where id=2;–需要对Id为2的这行加了一个行锁，但是有在事务B中已经加了，所以这个时候是拿不到锁的。除非事务B提交。</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Update t set k=k+1 where id=1;–需要对Id为1的这行加了一个行锁，但是有在事务A中已经加了，所以这个时候是拿不到锁的。除非事务A提交。</td>
</tr>
</tbody></table>
<p>以上就出现了一个死锁，事务A需要拿到id为2的那行的行锁，则需要事务B提交后释放锁，但是事务B提交的前提是拿到id为1的这行的行锁，但是这个行锁是有事务A拿着的，除非是事务A提交，如此则进去死锁状态，双方一致干等下去。</p>
</li>
</ol>
</li>
</ol>
</li>
</ol>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/08/20/java%E9%9D%A2%E8%AF%95%E9%A2%98/" rel="next" title="java面试题">
                <i class="fa fa-chevron-left"></i> java面试题
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/08/25/zookeeper%E9%80%89%E4%B8%BE/" rel="prev" title="zookeeper选举">
                zookeeper选举 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">tom</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#面试问题："><span class="nav-number">1.</span> <span class="nav-text">面试问题：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#下载安装"><span class="nav-number">2.</span> <span class="nav-text">下载安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#索引"><span class="nav-number">3.</span> <span class="nav-text">索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#索引的结构："><span class="nav-number">4.</span> <span class="nav-text">索引的结构：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#索引类型"><span class="nav-number">4.1.</span> <span class="nav-text">索引类型</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#索引覆盖"><span class="nav-number">4.1.1.</span> <span class="nav-text">索引覆盖</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#最左前缀原则"><span class="nav-number">4.1.2.</span> <span class="nav-text">最左前缀原则</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#在建立联合索引的时候，如何安排索-引内的字段顺序。"><span class="nav-number">4.1.3.</span> <span class="nav-text">在建立联合索引的时候，如何安排索 引内的字段顺序。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#索引下推"><span class="nav-number">4.1.4.</span> <span class="nav-text">索引下推</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#命令："><span class="nav-number">5.</span> <span class="nav-text">命令：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基础架构："><span class="nav-number">6.</span> <span class="nav-text">基础架构：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#日志模块："><span class="nav-number">7.</span> <span class="nav-text">日志模块：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#redo-log-（InnoDB引擎特有的日志）"><span class="nav-number">7.1.</span> <span class="nav-text">redo log （InnoDB引擎特有的日志）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#WAL技术-Write-Ahead-Logging"><span class="nav-number">7.1.1.</span> <span class="nav-text">WAL技术:(Write- Ahead Logging)</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#binlog（Server层的日志）归档日志"><span class="nav-number">7.2.</span> <span class="nav-text">binlog（Server层的日志）归档日志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#两者差异："><span class="nav-number">7.3.</span> <span class="nav-text">两者差异：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改数据的执行流程"><span class="nav-number">7.4.</span> <span class="nav-text">修改数据的执行流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#事务隔离："><span class="nav-number">7.5.</span> <span class="nav-text">事务隔离：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#锁"><span class="nav-number">7.6.</span> <span class="nav-text">锁</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#全局锁"><span class="nav-number">7.6.1.</span> <span class="nav-text">全局锁</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#表级锁"><span class="nav-number">7.6.2.</span> <span class="nav-text">表级锁</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#行锁"><span class="nav-number">7.6.3.</span> <span class="nav-text">行锁</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">tom</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
